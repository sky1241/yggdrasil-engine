<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>YGGDRASIL — Carte Vivante S0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a12;overflow:hidden;height:100vh;width:100vw;font-family:'Courier New',monospace;color:#ccc}
canvas{display:block;position:fixed;top:0;left:0}
#controls{position:fixed;top:14px;right:14px;z-index:10;background:rgba(0,0,0,0.5);padding:10px;border-radius:6px;display:flex;flex-direction:column;gap:6px;min-width:190px}
#controls label{font-size:10px;color:#888;cursor:pointer;display:flex;align-items:center;gap:5px}
#controls input[type=checkbox]{accent-color:#ffcc00}
#controls input[type=range]{width:100%;accent-color:#ffaa00}
#yearLabel{font-size:18px;font-weight:bold;color:#ffaa00;text-align:center}
#info{position:fixed;bottom:14px;left:14px;z-index:10;background:rgba(0,0,0,0.8);padding:12px;border-radius:6px;border:1px solid #333;display:none;max-width:400px;font-size:11px;line-height:1.6}
#bar{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);z-index:10;font-size:12px;color:rgba(255,255,255,0.2);white-space:nowrap}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="controls">
  <div id="yearLabel">2025</div>
  <input type="range" id="yearSlider" min="300" max="2025" step="10" value="2025">
  <label><input type="checkbox" id="cbLabels" checked> Labels</label>
  <label><input type="checkbox" id="cbPonts" checked> Ponts</label>
  <label><input type="checkbox" id="cbCapitales" checked> Capitales</label>
  <label><input type="checkbox" id="cbSubdoms"> Sous-domaines</label>
  <label><input type="checkbox" id="cbAnimer"> Animer</label>
  <label style="font-size:9px;color:#555">Vitesse <input type="range" id="speedSlider" min="1" max="20" value="5" style="width:80px"></label>
</div>
<div id="info"></div>
<div id="bar"></div>
<script>
const CONTINENTS=[{name:"MATHS",capitale:"=",color:"#ffcc00",isCenter:true,domains:[{name:"trigonométrie",symbols:23,first_year:300},{name:"nombres",symbols:9,first_year:800},{name:"nb théorie",symbols:57,first_year:1093},{name:"arithmétique",symbols:32,first_year:1557},{name:"analyse",symbols:259,first_year:1614},{name:"probabilités",symbols:295,first_year:1654},{name:"mathématique",symbols:983,first_year:1700},{name:"EDP",symbols:290,first_year:1747},{name:"optimisation",symbols:132,first_year:1788},{name:"complexes",symbols:1,first_year:1799},{name:"nb premiers",symbols:5,first_year:1800},{name:"algèbre lin",symbols:256,first_year:1850},{name:"logique",symbols:62,first_year:1878},{name:"ordinaux",symbols:1,first_year:1883},{name:"géom diff",symbols:24,first_year:1899},{name:"mesure",symbols:7,first_year:1902},{name:"analyse fonctionnelle",symbols:45,first_year:1906},{name:"ensembles",symbols:33,first_year:1908},{name:"combinatoire",symbols:59,first_year:1935},{name:"algèbre",symbols:471,first_year:1939},{name:"géométrie",symbols:251,first_year:1939},{name:"catégories",symbols:35,first_year:1945},{name:"topologie",symbols:293,first_year:1957},{name:"géom algébrique",symbols:64,first_year:1963}]},{name:"INGÉNIERIE",capitale:"Δt",color:"#748ffc",isCenter:false,domains:[{name:"astronomie",symbols:30,first_year:1609},{name:"contrôle",symbols:21,first_year:1868},{name:"signal",symbols:78,first_year:1965}]},{name:"PHYSIQUE",capitale:"ℏ",color:"#3bc9db",isCenter:false,domains:[{name:"optique",symbols:190,first_year:1621},{name:"mécanique",symbols:40,first_year:1687},{name:"gravitation",symbols:2,first_year:1687},{name:"mécanique analytique",symbols:7,first_year:1788},{name:"quantique",symbols:136,first_year:1900},{name:"relativité",symbols:62,first_year:1905},{name:"nucléaire",symbols:22,first_year:1911},{name:"particules",symbols:87,first_year:1928},{name:"électromagn",symbols:182,first_year:1931},{name:"cosmologie",symbols:22,first_year:1981},{name:"QFT",symbols:21,first_year:1983}]},{name:"CHIMIE",capitale:"mol",color:"#fab005",isCenter:false,domains:[{name:"fluides",symbols:42,first_year:1755},{name:"chimie",symbols:11,first_year:1789},{name:"thermo",symbols:123,first_year:1824},{name:"mécanique stat",symbols:4,first_year:1877}]},{name:"FINANCE",capitale:"$",color:"#ff8e72",isCenter:false,domains:[{name:"statistiques",symbols:82,first_year:1805},{name:"stochastique",symbols:38,first_year:1923},{name:"économie",symbols:30,first_year:1950},{name:"finance",symbols:7,first_year:1973}]},{name:"IA/CS",capitale:"NP",color:"#da77f2",isCenter:false,domains:[{name:"calculabilité",symbols:14,first_year:1928},{name:"automates",symbols:46,first_year:1936},{name:"information",symbols:22,first_year:1948},{name:"complexité",symbols:22,first_year:1956},{name:"crypto",symbols:62,first_year:1976},{name:"ML",symbols:84,first_year:1984}]},{name:"BIO",capitale:"DNA",color:"#69db7c",isCenter:false,domains:[{name:"biologie",symbols:11,first_year:1953}]}];

const cv=document.getElementById('c'),ctx=cv.getContext('2d');
const yearSlider=document.getElementById('yearSlider');
const yearLabel=document.getElementById('yearLabel');
const cbLabels=document.getElementById('cbLabels');
const cbPonts=document.getElementById('cbPonts');
const cbCapitales=document.getElementById('cbCapitales');
const cbSubdoms=document.getElementById('cbSubdoms');
const cbAnimer=document.getElementById('cbAnimer');
const speedSlider=document.getElementById('speedSlider');
const infoEl=document.getElementById('info');
const barEl=document.getElementById('bar');

let W,H,cx,cy,scale;
function resize(){W=cv.width=innerWidth;H=cv.height=innerHeight;cx=W/2;cy=H/2;scale=Math.min(W,H)}
resize();addEventListener('resize',resize);

let mx=-9999,my=-9999,hovered=-1;
cv.addEventListener('mousemove',function(e){mx=e.clientX;my=e.clientY});
cv.addEventListener('mouseleave',function(){mx=-9999;my=-9999});

function getYear(){return parseInt(yearSlider.value)}

function countSymbols(cont,year){
  var total=0,visibleDoms=0,domDetails=[];
  for(var j=0;j<cont.domains.length;j++){
    var d=cont.domains[j];
    if(d.first_year>year)continue;
    visibleDoms++;
    var age=year-d.first_year;
    var growth=Math.min(1,age/50);
    var count=Math.round(d.symbols*growth);
    total+=count;
    domDetails.push({name:d.name,count:count,symbols:d.symbols,first_year:d.first_year});
  }
  return{total:total,visibleDoms:visibleDoms,visible:visibleDoms>0,domDetails:domDetails};
}

function hexToRgb(hex){
  return{r:parseInt(hex.slice(1,3),16),g:parseInt(hex.slice(3,5),16),b:parseInt(hex.slice(5,7),16)};
}

function computeRadius(symbolCount,maxSymbols){
  return Math.sqrt(symbolCount/maxSymbols)*scale*0.22;
}

function draw(){
  var year=getYear();
  ctx.clearRect(0,0,W,H);

  // Compute MATHS data
  var mathsCont=CONTINENTS[0];
  var mathsInfo=countSymbols(mathsCont,year);

  // Compute max symbols (always MATHS at 2025, for stable proportions)
  var maxSym=0;
  for(var i=0;i<CONTINENTS.length;i++){
    var ci=countSymbols(CONTINENTS[i],year);
    if(ci.total>maxSym)maxSym=ci.total;
  }
  if(maxSym<1)maxSym=1;

  var mathsR=computeRadius(mathsInfo.total,maxSym);

  // Compute visible planets
  var planets=[];
  for(var i=1;i<CONTINENTS.length;i++){
    var info=countSymbols(CONTINENTS[i],year);
    if(info.visible&&info.total>0){
      planets.push({idx:i,cont:CONTINENTS[i],info:info});
    }
  }

  // ═══ SOLEIL: lueur dorée ═══
  var glowR=scale*0.45;
  var glow=ctx.createRadialGradient(cx,cy,0,cx,cy,glowR);
  glow.addColorStop(0,'rgba(255,204,0,0.06)');
  glow.addColorStop(1,'transparent');
  ctx.fillStyle=glow;
  ctx.beginPath();ctx.arc(cx,cy,glowR,0,Math.PI*2);ctx.fill();

  // ═══ CERCLE MATHS ═══
  if(mathsInfo.visible){
    var mc=hexToRgb(mathsCont.color);
    ctx.beginPath();ctx.arc(cx,cy,mathsR,0,Math.PI*2);
    ctx.fillStyle='rgba('+mc.r+','+mc.g+','+mc.b+',0.1)';ctx.fill();
    ctx.strokeStyle='rgba('+mc.r+','+mc.g+','+mc.b+',0.4)';ctx.lineWidth=2;ctx.stroke();

    if(cbLabels.checked){
      ctx.fillStyle=mathsCont.color+'88';ctx.font='11px Courier New';ctx.textAlign='center';ctx.textBaseline='bottom';
      ctx.fillText('MATHS',cx,cy-mathsR+16);
      ctx.fillStyle=mathsCont.color+'55';ctx.font='9px Courier New';ctx.textBaseline='top';
      ctx.fillText(mathsInfo.total+' sym \u00b7 '+mathsInfo.visibleDoms+' dom',cx,cy+mathsR-16);
    }

    // ═══ SOUS-DOMAINES MATHS ═══
    if(cbSubdoms.checked&&mathsInfo.domDetails.length>0){
      drawSubdomains(cx,cy,mathsR,mathsInfo.domDetails,mathsCont.color,maxSym);
    }
  }

  // ═══ SYMBOLE = ═══
  ctx.fillStyle='#ffcc00';ctx.font='bold 30px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('=',cx,cy);

  // ═══ PLANÈTES ═══
  var planetPos=[];
  hovered=-1;

  // Check hover on MATHS
  var dxm=mx-cx,dym=my-cy;
  if(dxm*dxm+dym*dym<mathsR*mathsR)hovered=0;

  for(var p=0;p<planets.length;p++){
    var pl=planets[p];
    var angle=(p/planets.length)*Math.PI*2-Math.PI/2;
    var plR=computeRadius(pl.info.total,maxSym);
    var dist=mathsR+plR;
    var px=cx+Math.cos(angle)*dist;
    var py=cy+Math.sin(angle)*dist;
    planetPos.push({px:px,py:py,r:plR,angle:angle,pl:pl,idx:pl.idx});

    // Hit test
    var dx=mx-px,dy=my-py;
    if(dx*dx+dy*dy<plR*plR)hovered=pl.idx;

    var pc=hexToRgb(pl.cont.color);
    var isHov=hovered===pl.idx;

    // ═══ LIGNE MATHS → PLANÈTE ═══
    var normX=Math.cos(angle),normY=Math.sin(angle);
    var bx=cx+normX*mathsR,by=cy+normY*mathsR;
    var ex=px-normX*plR,ey=py-normY*plR;
    ctx.beginPath();ctx.moveTo(bx,by);ctx.lineTo(ex,ey);
    ctx.strokeStyle='rgba('+pc.r+','+pc.g+','+pc.b+',0.4)';ctx.lineWidth=2;ctx.stroke();

    // Point de contact sur MATHS
    ctx.beginPath();ctx.arc(bx,by,3,0,Math.PI*2);
    ctx.fillStyle=pl.cont.color;ctx.fill();

    // ═══ CERCLE PLANÈTE ═══
    ctx.beginPath();ctx.arc(px,py,plR,0,Math.PI*2);
    ctx.fillStyle='rgba('+pc.r+','+pc.g+','+pc.b+','+(isHov?'0.3':'0.15')+')';ctx.fill();
    ctx.strokeStyle=isHov?(pl.cont.color+'CC'):'rgba('+pc.r+','+pc.g+','+pc.b+',0.55)';
    ctx.lineWidth=isHov?2.5:1;ctx.stroke();

    // ═══ NOYAU DUR ═══
    if(cbCapitales.checked){
      var coreR=plR*0.3;
      ctx.beginPath();ctx.arc(px,py,coreR,0,Math.PI*2);
      ctx.fillStyle='rgba('+pc.r+','+pc.g+','+pc.b+',0.5)';ctx.fill();
      var capSize=Math.max(10,Math.min(22,plR*0.4));
      ctx.fillStyle=pl.cont.color;ctx.font='bold '+capSize+'px Courier New';
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(pl.cont.capitale,px,py);
    }

    // ═══ LABEL ═══
    if(cbLabels.checked){
      var labelDist=plR+14;
      var lx=px+normX*labelDist,ly=py+normY*labelDist;
      var fontSize=Math.max(9,Math.min(14,plR*0.3));
      ctx.fillStyle=pl.cont.color+'CC';ctx.font=fontSize+'px Courier New';
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(pl.cont.name,lx,ly);
      ctx.fillStyle=pl.cont.color+'66';ctx.font='8px Courier New';
      ctx.fillText(pl.info.total+' sym',lx,ly+fontSize+2);
    }

    // ═══ SOUS-DOMAINES PLANÈTE ═══
    if(cbSubdoms.checked&&pl.info.domDetails.length>0){
      drawSubdomains(px,py,plR,pl.info.domDetails,pl.cont.color,maxSym);
    }
  }

  // ═══ PONTS ET TROUS ═══
  if(cbPonts.checked){
    for(var a=0;a<planetPos.length;a++){
      for(var b=a+1;b<planetPos.length;b++){
        var pa=planetPos[a],pb=planetPos[b];
        var dx=pa.px-pb.px,dy=pa.py-pb.py;
        var dist=Math.sqrt(dx*dx+dy*dy);
        var sumR=pa.r+pb.r;
        var threshold=sumR*1.3;

        if(dist<threshold){
          var overlap=1-dist/threshold;
          ctx.save();
          ctx.setLineDash([4,6]);
          ctx.beginPath();ctx.moveTo(pa.px,pa.py);ctx.lineTo(pb.px,pb.py);
          ctx.strokeStyle='rgba(255,255,255,'+(0.1+overlap*0.3)+')';ctx.lineWidth=1;ctx.stroke();
          ctx.setLineDash([]);
          var midX=(pa.px+pb.px)/2,midY=(pa.py+pb.py)/2;
          var bg=ctx.createRadialGradient(midX,midY,0,midX,midY,8);
          bg.addColorStop(0,'rgba(255,255,255,'+(0.15*overlap)+')');
          bg.addColorStop(1,'transparent');
          ctx.fillStyle=bg;
          ctx.beginPath();ctx.arc(midX,midY,8,0,Math.PI*2);ctx.fill();
          ctx.restore();
        }else{
          var diffIdx=Math.abs(a-b);
          var isNeighbor=diffIdx===1||diffIdx===planetPos.length-1;
          if(isNeighbor){
            ctx.save();
            ctx.setLineDash([3,8]);
            ctx.beginPath();ctx.moveTo(pa.px,pa.py);ctx.lineTo(pb.px,pb.py);
            ctx.strokeStyle='rgba(255,50,50,0.08)';ctx.lineWidth=1;ctx.stroke();
            ctx.setLineDash([]);
            ctx.restore();
          }
        }
      }
    }
  }

  // ═══ HOVER INFO ═══
  if(hovered>=0){
    var cont=CONTINENTS[hovered];
    var d=countSymbols(cont,year);
    var firstYear=Infinity;
    for(var j=0;j<cont.domains.length;j++){
      if(cont.domains[j].first_year<firstYear)firstYear=cont.domains[j].first_year;
    }
    var domList=d.domDetails.map(function(x){return x.name+' ('+x.count+'/'+x.symbols+')'}).join(', ');
    infoEl.innerHTML='<span style="font-size:14px;font-weight:bold;color:'+cont.color+'">'+cont.name+'</span> <span style="color:#666">\u00b7 capitale: <span style="color:'+cont.color+'">'+cont.capitale+'</span></span><br>Symboles: '+d.total+' \u00b7 Depuis: '+firstYear+'<br><br><span style="color:#555">Domaines: '+domList+'</span>';
    infoEl.style.display='block';
  }else{
    infoEl.style.display='none';
  }

  // ═══ BARRE DU BAS ═══
  var totalSym=mathsInfo.total;
  for(var p=0;p<planets.length;p++)totalSym+=planets[p].info.total;
  var nCont=1+(planets.length);
  barEl.textContent=year+' \u00b7 '+nCont+' continents \u00b7 '+totalSym+' symboles \u00b7 = centre absolu';
}

// ═══ SOUS-DOMAINES ═══
function drawSubdomains(cx,cy,parentR,domDetails,parentColor,maxSym){
  if(domDetails.length===0)return;
  var pc=hexToRgb(parentColor);
  var maxDomSym=0;
  for(var j=0;j<domDetails.length;j++){
    if(domDetails[j].count>maxDomSym)maxDomSym=domDetails[j].count;
  }
  if(maxDomSym<1)return;

  var innerR=parentR*0.55;
  for(var j=0;j<domDetails.length;j++){
    var dd=domDetails[j];
    var subR=Math.max(2,Math.sqrt(dd.count/maxDomSym)*parentR*0.22);
    var angle=(j/domDetails.length)*Math.PI*2-Math.PI/2;
    var sx=cx+Math.cos(angle)*innerR;
    var sy=cy+Math.sin(angle)*innerR;

    ctx.beginPath();ctx.arc(sx,sy,subR,0,Math.PI*2);
    ctx.fillStyle='rgba('+pc.r+','+pc.g+','+pc.b+',0.25)';ctx.fill();
    ctx.strokeStyle='rgba('+pc.r+','+pc.g+','+pc.b+',0.35)';ctx.lineWidth=0.5;ctx.stroke();

    if(subR>5){
      var fs=Math.max(6,Math.min(9,subR*0.7));
      ctx.fillStyle='rgba('+pc.r+','+pc.g+','+pc.b+',0.7)';
      ctx.font=fs+'px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
      var label=dd.name.length>8?dd.name.slice(0,7)+'.':dd.name;
      ctx.fillText(label,sx,sy);
    }
  }
}

// ═══ ANIMATION ═══
function loop(){
  if(cbAnimer.checked){
    var y=getYear()+parseInt(speedSlider.value);
    if(y>2025)y=300;
    yearSlider.value=y;
    yearLabel.textContent=y;
  }
  draw();
  requestAnimationFrame(loop);
}

yearSlider.addEventListener('input',function(){yearLabel.textContent=yearSlider.value});
loop();
</script>
</body>
</html>
