<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Yggdrasil — Film du Mycélium</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a0f; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
#header {
  text-align: center; padding: 10px 0 5px;
  background: linear-gradient(180deg, #12121a, #0a0a0f);
}
#header h1 { font-size: 20px; color: #aaa; letter-spacing: 4px; }
#stats {
  display: flex; justify-content: center; gap: 40px;
  padding: 8px 0; font-size: 14px; color: #888;
}
#stats .val { color: #fff; font-weight: bold; font-size: 18px; }
#year-display {
  font-size: 72px; font-weight: 900; text-align: center;
  color: #fff; text-shadow: 0 0 30px rgba(100,200,255,0.3);
  padding: 0; line-height: 1; margin: -5px 0 5px;
}
#phase-label {
  text-align: center; font-size: 13px; color: #666;
  text-transform: uppercase; letter-spacing: 3px; margin-bottom: 5px;
}
#glyph-display {
  text-align: center; font-size: 28px; min-height: 40px;
  color: #ffd700; padding: 5px; letter-spacing: 8px;
}
canvas { display: block; margin: 0 auto; }
#controls {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: linear-gradient(0deg, #12121a, transparent);
  padding: 15px 30px 20px;
}
#timeline-row {
  display: flex; align-items: center; gap: 12px;
  max-width: 900px; margin: 0 auto;
}
#play-btn {
  width: 40px; height: 40px; border-radius: 50%;
  background: #333; border: 1px solid #555; color: #fff;
  font-size: 18px; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
}
#play-btn:hover { background: #444; }
#slider {
  flex: 1; -webkit-appearance: none; appearance: none;
  height: 6px; background: #333; border-radius: 3px;
  outline: none;
}
#slider::-webkit-slider-thumb {
  -webkit-appearance: none; width: 16px; height: 16px;
  border-radius: 50%; background: #4af; cursor: pointer;
}
#frame-info { font-size: 12px; color: #666; flex-shrink: 0; min-width: 100px; text-align: right; }
#speed-row {
  display: flex; justify-content: center; gap: 8px; margin-top: 8px;
}
.speed-btn {
  padding: 3px 12px; border-radius: 12px;
  background: #222; border: 1px solid #444; color: #aaa;
  font-size: 12px; cursor: pointer;
}
.speed-btn.active { background: #4af; color: #000; border-color: #4af; }
#legend {
  position: fixed; right: 15px; top: 50%; transform: translateY(-50%);
  font-size: 12px; line-height: 2;
}
.legend-item { display: flex; align-items: center; gap: 6px; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; }
#growth-chart {
  position: fixed; left: 15px; bottom: 100px;
  width: 200px; height: 120px;
}
</style>
</head>
<body>

<div id="header">
  <h1>YGGDRASIL — FILM DU MYCÉLIUM</h1>
</div>
<div id="phase-label">—</div>
<div id="year-display">—</div>
<div id="glyph-display"></div>
<div id="stats">
  <div>Concepts <span class="val" id="s-concepts">0</span></div>
  <div>Edges <span class="val" id="s-edges">0</span></div>
  <div>Espèces actives <span class="val" id="s-species">0</span></div>
</div>

<canvas id="canvas"></canvas>

<div id="legend"></div>

<div id="controls">
  <div id="timeline-row">
    <button id="play-btn">▶</button>
    <input type="range" id="slider" min="0" max="100" value="0">
    <div id="frame-info">0 / 0</div>
  </div>
  <div id="speed-row">
    <button class="speed-btn active" data-speed="1">1x</button>
    <button class="speed-btn" data-speed="3">3x</button>
    <button class="speed-btn" data-speed="10">10x</button>
    <button class="speed-btn" data-speed="30">30x</button>
    <button class="speed-btn" data-speed="100">MAX</button>
  </div>
</div>

<script>
const SPECIES = [
  { id: 0, name: 'ChiMat', full: 'Chimie / Matériaux',   color: '#FF6B35' },
  { id: 1, name: 'TerGeo', full: 'Terre / Géosciences',  color: '#8B6914' },
  { id: 2, name: 'BioCli', full: 'Bio / Clinique',        color: '#2ECC71' },
  { id: 3, name: 'HumEco', full: 'Humanités / Économie',  color: '#F1C40F' },
  { id: 4, name: 'InfMat', full: 'Info / Mathématiques',  color: '#3498DB' },
  { id: 5, name: 'TerBio', full: 'Terre / Biologie',      color: '#27AE60' },
  { id: 6, name: 'HumArt', full: 'Humanités / Art',       color: '#E056A0' },
  { id: 7, name: 'BioLab', full: 'Bio / Laboratoire',     color: '#1ABC9C' },
  { id: 8, name: 'Physiq', full: 'Physique',               color: '#E74C3C' },
];
const K = 9;

let frames = [];
let currentFrame = 0;
let playing = false;
let speed = 1;
let animId = null;
let lastTime = 0;
let accumulator = 0;

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function resize() {
  const w = window.innerWidth;
  const h = window.innerHeight - 220;
  canvas.width = w;
  canvas.height = Math.max(h, 300);
}
window.addEventListener('resize', resize);
resize();

// Build legend
const legendEl = document.getElementById('legend');
SPECIES.forEach(sp => {
  const d = document.createElement('div');
  d.className = 'legend-item';
  d.innerHTML = `<div class="legend-dot" style="background:${sp.color}"></div><span>${sp.name}</span>`;
  legendEl.appendChild(d);
});

// Load data
async function loadData() {
  document.getElementById('year-display').textContent = 'Chargement...';
  try {
    const resp = await fetch('../data/scan/frames.json');
    const data = await resp.json();
    frames = data.frames;
    document.getElementById('slider').max = frames.length - 1;
    document.getElementById('year-display').textContent = '—';
    showFrame(0);
  } catch(e) {
    // Try loading via file input if fetch fails
    document.getElementById('year-display').textContent = 'Erreur';
    document.getElementById('phase-label').textContent =
      'Lancez: python -m http.server depuis le dossier racine du repo, puis ouvrez http://localhost:8000/viz/mycelium_film.html';
  }
}

function fmt(n) {
  if (n >= 1e9) return (n/1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n/1e3).toFixed(1) + 'K';
  return String(n);
}

function showFrame(idx) {
  if (idx < 0 || idx >= frames.length) return;
  currentFrame = idx;
  const fr = frames[idx];
  const slider = document.getElementById('slider');
  slider.value = idx;

  // Year
  const year = fr.year;
  const yearStr = year < 0 ? `${Math.abs(year).toLocaleString()} av. J-C` : String(year);
  const periodStr = fr.period;
  document.getElementById('year-display').textContent = fr.phase === 'data' && fr.period.includes('-')
    ? fr.period : yearStr;

  // Phase
  document.getElementById('phase-label').textContent =
    fr.phase === 'historical' ? 'Phase 1 — Graines S-2 (historique)'
    : 'Phase 2 — Data OpenAlex (479M papers)';

  // Glyphs
  if (fr.phase === 'historical') {
    document.getElementById('glyph-display').textContent = (fr.all_glyphs || []).join('  ');
  } else {
    document.getElementById('glyph-display').textContent = '';
  }

  // Stats
  const concepts = fr.concepts_active || 0;
  const edges = fr.edges_cumulative || fr.edges || 0;
  document.getElementById('s-concepts').textContent = fmt(concepts);
  document.getElementById('s-edges').textContent = fmt(edges);

  // Active species
  const speciesCounts = fr.concepts_by_species || [0,0,0,0,0,0,0,0,0];
  const activeSpecies = speciesCounts.filter(c => c > 0).length;
  document.getElementById('s-species').textContent = activeSpecies + ' / 9';

  document.getElementById('frame-info').textContent = `${idx + 1} / ${frames.length}`;

  drawFrame(fr);
}

function drawFrame(fr) {
  const W = canvas.width;
  const H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  const cx = W / 2;
  const cy = H / 2;
  const R = Math.min(cx, cy) * 0.55; // circle radius for layout

  const speciesCounts = fr.concepts_by_species || [0,0,0,0,0,0,0,0,0];
  const mat = fr.species_matrix || Array.from({length:K}, () => Array(K).fill(0));
  const maxCount = Math.max(1, ...speciesCounts);
  const totalConcepts = fr.concepts_active || fr.total_glyphs || 0;

  // Compute positions
  const positions = SPECIES.map((sp, i) => {
    const angle = (i / K) * Math.PI * 2 - Math.PI / 2;
    return { x: cx + Math.cos(angle) * R, y: cy + Math.sin(angle) * R };
  });

  // Draw edges (inter-species connections)
  let maxEdge = 0;
  for (let i = 0; i < K; i++)
    for (let j = i + 1; j < K; j++)
      maxEdge = Math.max(maxEdge, mat[i][j]);

  if (maxEdge > 0) {
    for (let i = 0; i < K; i++) {
      for (let j = i + 1; j < K; j++) {
        const w = mat[i][j];
        if (w <= 0) continue;
        const strength = w / maxEdge;
        if (strength < 0.01) continue;
        const alpha = Math.min(0.7, strength * 0.8 + 0.05);
        const lineWidth = 1 + strength * 8;
        ctx.beginPath();
        ctx.moveTo(positions[i].x, positions[i].y);
        ctx.lineTo(positions[j].x, positions[j].y);
        // gradient between species colors
        const grad = ctx.createLinearGradient(positions[i].x, positions[i].y, positions[j].x, positions[j].y);
        grad.addColorStop(0, hexToRgba(SPECIES[i].color, alpha));
        grad.addColorStop(1, hexToRgba(SPECIES[j].color, alpha));
        ctx.strokeStyle = grad;
        ctx.lineWidth = lineWidth;
        ctx.stroke();
      }
    }
  }

  // Draw species nodes
  SPECIES.forEach((sp, i) => {
    const count = speciesCounts[i];
    const ratio = count / maxCount;
    const minR = totalConcepts > 0 ? 8 : 15;
    const maxR = Math.min(W, H) * 0.08;
    const r = minR + ratio * (maxR - minR);
    const p = positions[i];

    // Glow
    if (count > 0) {
      const glow = ctx.createRadialGradient(p.x, p.y, r * 0.5, p.x, p.y, r * 2.5);
      glow.addColorStop(0, hexToRgba(sp.color, 0.3));
      glow.addColorStop(1, hexToRgba(sp.color, 0));
      ctx.beginPath();
      ctx.arc(p.x, p.y, r * 2.5, 0, Math.PI * 2);
      ctx.fillStyle = glow;
      ctx.fill();
    }

    // Circle
    ctx.beginPath();
    ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
    ctx.fillStyle = count > 0 ? hexToRgba(sp.color, 0.8) : '#222';
    ctx.fill();
    ctx.strokeStyle = count > 0 ? sp.color : '#444';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Label
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 13px Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText(sp.name, p.x, p.y + r + 18);

    // Count
    if (count > 0) {
      ctx.fillStyle = '#aaa';
      ctx.font = '11px Segoe UI';
      ctx.fillText(fmt(count), p.x, p.y + r + 32);
    }

    // Number inside circle
    if (count > 0 && r > 15) {
      ctx.fillStyle = '#fff';
      ctx.font = `bold ${Math.max(10, r * 0.5)}px Segoe UI`;
      ctx.fillText(fmt(count), p.x, p.y + 4);
    }
  });

  // Historical: show new glyph big in center
  if (fr.phase === 'historical' && fr.new_glyphs && fr.new_glyphs.length > 0) {
    ctx.fillStyle = '#ffd700';
    ctx.font = 'bold 60px serif';
    ctx.textAlign = 'center';
    const glyphs = fr.new_glyphs.join(' ');
    ctx.fillText(glyphs, cx, cy + 20);

    ctx.fillStyle = '#888';
    ctx.font = '16px Segoe UI';
    const names = (fr.new_names || []).join(', ');
    ctx.fillText(names, cx, cy + 55);
  }

  // Draw mini growth curves at bottom-left
  drawGrowthMini(cx, cy);
}

function drawGrowthMini(mainCx, mainCy) {
  if (currentFrame < 5 || frames[currentFrame].phase === 'historical') return;

  const chartW = 180, chartH = 80;
  const x0 = 15, y0 = canvas.height - chartH - 15;

  ctx.fillStyle = 'rgba(10,10,15,0.8)';
  ctx.fillRect(x0, y0, chartW, chartH);
  ctx.strokeStyle = '#333';
  ctx.strokeRect(x0, y0, chartW, chartH);

  // Sample frames for chart
  const step = Math.max(1, Math.floor(currentFrame / chartW));
  const points = [];
  let maxE = 1;
  for (let i = 4; i <= currentFrame; i += step) {
    const e = frames[i].edges_cumulative || 0;
    points.push(e);
    if (e > maxE) maxE = e;
  }

  if (points.length < 2) return;

  ctx.beginPath();
  points.forEach((e, pi) => {
    const px = x0 + (pi / (points.length - 1)) * chartW;
    const py = y0 + chartH - (e / maxE) * (chartH - 10) - 5;
    if (pi === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  });
  ctx.strokeStyle = '#4af';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  ctx.fillStyle = '#666';
  ctx.font = '9px Segoe UI';
  ctx.textAlign = 'left';
  ctx.fillText('edges ' + fmt(maxE), x0 + 3, y0 + 10);
}

function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

// Controls
document.getElementById('play-btn').addEventListener('click', () => {
  playing = !playing;
  document.getElementById('play-btn').textContent = playing ? '⏸' : '▶';
  if (playing) {
    lastTime = performance.now();
    accumulator = 0;
    requestAnimationFrame(animate);
  }
});

document.getElementById('slider').addEventListener('input', (e) => {
  showFrame(parseInt(e.target.value));
});

document.querySelectorAll('.speed-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    speed = parseInt(btn.dataset.speed);
  });
});

// Keyboard
document.addEventListener('keydown', (e) => {
  if (e.key === ' ') {
    e.preventDefault();
    document.getElementById('play-btn').click();
  } else if (e.key === 'ArrowRight') {
    showFrame(Math.min(currentFrame + 1, frames.length - 1));
  } else if (e.key === 'ArrowLeft') {
    showFrame(Math.max(currentFrame - 1, 0));
  } else if (e.key === 'Home') {
    showFrame(0);
  } else if (e.key === 'End') {
    showFrame(frames.length - 1);
  }
});

function animate(now) {
  if (!playing) return;
  const dt = now - lastTime;
  lastTime = now;

  // frames per second based on speed
  const fps = speed <= 10 ? speed * 5 : 200;
  accumulator += dt;
  const interval = 1000 / fps;

  while (accumulator >= interval) {
    accumulator -= interval;
    if (currentFrame < frames.length - 1) {
      showFrame(currentFrame + 1);
    } else {
      playing = false;
      document.getElementById('play-btn').textContent = '▶';
      return;
    }
  }

  requestAnimationFrame(animate);
}

// Init
loadData();
</script>
</body>
</html>
